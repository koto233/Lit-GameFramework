using UnityEditor;
using UnityEngine;
using System.Reflection;
using System.Collections.Generic;
using System.Linq;

[CustomEditor(typeof(UIBase), true)]
public class UIBaseInspector : Editor
{
    List<string> _autoFields = new List<string>();

    void OnEnable()
    {
        CacheAutoGeneratedFields();
    }

    public override void OnInspectorGUI()
    {
        serializedObject.Update();

        // 1ï¸âƒ£ ç”»è‡ªåŠ¨ç”Ÿæˆå­—æ®µï¼ˆç°è‰²ï¼‰
        DrawAutoGeneratedFields();

        EditorGUILayout.Space();

        // 2ï¸âƒ£ ç”»å…¶ä½™æ­£å¸¸å­—æ®µ
        DrawPropertiesExcluding(
            serializedObject,
            _autoFields.Append("m_Script").ToArray()
        );

        serializedObject.ApplyModifiedProperties();

        GUILayout.Space(10);
        GUILayout.Label("UI è‡ªåŠ¨ç»‘å®š", EditorStyles.boldLabel);

        if (GUILayout.Button("ğŸ”§ ç”Ÿæˆ UI ç»‘å®šä»£ç "))
        {
            UIAutoBindGenerator.Generate(target as UIBase);
        }
    }

    void CacheAutoGeneratedFields()
    {
        _autoFields.Clear();

        var type = target.GetType();
        var fields = type.GetFields(
            BindingFlags.Instance |
            BindingFlags.NonPublic |
            BindingFlags.Public);

        foreach (var f in fields)
        {
            if (!f.Name.StartsWith("_"))
                continue;

            if (!typeof(Component).IsAssignableFrom(f.FieldType))
                continue;

            _autoFields.Add(f.Name);
        }
    }

    void DrawAutoGeneratedFields()
    {
        if (_autoFields.Count == 0)
            return;

        EditorGUILayout.LabelField("Auto Generated Bindings", EditorStyles.boldLabel);

        EditorGUI.BeginDisabledGroup(true);

        foreach (var name in _autoFields)
        {
            var prop = serializedObject.FindProperty(name);
            if (prop != null)
            {
                EditorGUILayout.PropertyField(prop);
            }
        }

        EditorGUI.EndDisabledGroup();
    }
}
